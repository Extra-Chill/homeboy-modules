{
  "name": "WordPress",
  "version": "1.0.0",
  "icon": "w.circle.fill",
  "description": "WordPress project type with WP-CLI integration",
  "author": "Extra Chill",
  "config_schema": "wordpress",

  "discovery": {
    "find_command": "find /home /var/www /srv -maxdepth 6 -name 'wp-config.php' -type f 2>/dev/null | head -20",
    "base_path_transform": "dirname",
    "display_name_command": "cd {{basePath}} && wp option get blogname --skip-themes --skip-plugins 2>/dev/null || basename {{basePath}}"
  },

  "cli": {
    "tool": "wp",
    "display_name": "WP-CLI",
    "command_template": "cd {{sitePath}} && {{cliPath}} {{args}} --url={{domain}}",
    "default_cli_path": "wp",
    "settings_flags": {
      "user": "--user={{value}}"
    }
  },

  "default_pinned_files": ["wp-config.php", ".htaccess", "robots.txt"],
  "default_pinned_logs": ["wp-content/debug.log"],

  "database": {
    "cli": {
      "tables_command": "cd {{sitePath}} && {{cliPath}} db query \"SHOW TABLE STATUS\" --format={{format}} --url={{domain}}",
      "describe_command": "cd {{sitePath}} && {{cliPath}} db query \"DESCRIBE {{table}}\" --format={{format}} --url={{domain}}",
      "query_command": "cd {{sitePath}} && {{cliPath}} db query \"{{query}}\" --format={{format}} --url={{domain}}"
    },

    "default_table_prefix": "wp_",
    "prefix_detection_suffixes": ["options", "posts", "users"],

    "table_suffixes": {
      "core": ["commentmeta", "comments", "links", "options", "postmeta",
               "posts", "termmeta", "terms", "term_relationships", "term_taxonomy"],
      "users": ["users", "usermeta"],
      "network": ["blogs", "blogmeta", "site", "sitemeta", "registration_log", "signups"]
    },

    "protected_suffixes": ["options", "posts", "postmeta", "users", "usermeta",
                          "comments", "commentmeta", "terms", "termmeta",
                          "term_relationships", "term_taxonomy", "links",
                          "blogs", "blogmeta", "site", "sitemeta",
                          "registration_log", "signups"],

    "default_grouping": {
      "id": "wordpress-tables",
      "name": "WordPress Tables",
      "pattern_template": "{{prefix}}*"
    },

    "multisite_grouping": {
      "network": {
        "id": "wordpress-network",
        "name": "Network Tables"
      },
      "site": {
        "id_template": "wordpress-site-{{blogId}}",
        "name_template": "{{siteName}}",
        "pattern_template": "{{sitePrefix}}*"
      }
    }
  },

  "deploy": [
    {
      "path_pattern": "/wp-content/plugins/",
      "verify_command": "find {{targetDir}} -maxdepth 2 -name '*.php' -exec grep -l 'Plugin Name:' {} + 2>/dev/null | head -1",
      "verify_error_message": "No WordPress plugin header found in {{targetDir}}"
    },
    {
      "path_pattern": "/wp-content/themes/",
      "verify_command": "grep -l 'Theme Name:' {{targetDir}}/style.css 2>/dev/null",
      "verify_error_message": "No WordPress theme header found in {{targetDir}}/style.css"
    }
  ],

  "deploy_override": [
    {
      "path_pattern": "/wp-content/plugins/",
      "staging_path": "/tmp/homeboy-staging",
      "install_command": "cd {{siteRoot}} && plugin_slug=$(basename {{targetDir}}) && ({{cliPath}} plugin deactivate $plugin_slug --url={{domain}} 2>/dev/null || ([ -d {{targetDir}} ] && echo 'WARNING: Removing broken plugin directory' && rm -rf {{targetDir}}) || true) && {{cliPath}} plugin install {{stagingArtifact}} --force --activate --url={{domain}}",
      "cleanup_command": "rm -f {{stagingArtifact}}",
      "skip_permissions_fix": true
    },
    {
      "path_pattern": "/wp-content/themes/",
      "staging_path": "/tmp/homeboy-staging",
      "install_command": "cd {{siteRoot}} && theme_slug=$(basename {{targetDir}}) && ({{cliPath}} theme deactivate --url={{domain}} 2>/dev/null; [ -d {{targetDir}} ] && echo 'WARNING: Removing existing theme directory' && rm -rf {{targetDir}} || true) && {{cliPath}} theme install {{stagingArtifact}} --force --url={{domain}}",
      "cleanup_command": "rm -f {{stagingArtifact}}",
      "skip_permissions_fix": true
    }
  ],

  "version_patterns": [
    {
      "extension": ".php",
      "pattern": "Version:\\s*(\\d+\\.\\d+\\.\\d+)"
    }
  ],

  "build": {
    "artifact_extensions": [".zip"],
    "script_names": ["build.sh"],
    "command_template": "bash {{script}}",
    "module_script": "scripts/build.sh"
  },

  "commands": ["wp"]
}
