{
  "name": "WordPress",
  "version": "1.0.1",
  "icon": "w.circle.fill",
  "description": "WordPress project type with WP-CLI integration",
  "author": "Extra Chill",
  "config_schema": "wordpress",

  "discovery": {
    "find_command": "find /home /var/www /srv -maxdepth 6 -name 'wp-config.php' -type f 2>/dev/null | head -20",
    "base_path_transform": "dirname",
    "display_name_command": "cd {{basePath}} && wp option get blogname --skip-themes --skip-plugins 2>/dev/null || basename {{basePath}}"
  },

  "cli": {
    "tool": "wp",
    "display_name": "WP-CLI",
    "command_template": "{{cliPath}} {{args}} --path={{sitePath}} --url={{domain}}",
    "working_dir_template": "{{sitePath}}",
    "default_cli_path": "wp",
    "settings_flags": {
      "user": "--user={{value}}"
    }
  },

  "default_pinned_files": ["wp-config.php", ".htaccess", "robots.txt"],
  "default_pinned_logs": ["wp-content/debug.log"],

  "database": {
    "cli": {
      "tables_command": "cd {{sitePath}} && {{cliPath}} db query \"SHOW TABLE STATUS\" --format={{format}} --url={{domain}}",
      "describe_command": "cd {{sitePath}} && {{cliPath}} db query \"DESCRIBE {{table}}\" --format={{format}} --url={{domain}}",
      "query_command": "cd {{sitePath}} && {{cliPath}} db query \"{{query}}\" --format={{format}} --url={{domain}}"
    },

    "default_table_prefix": "wp_",
    "prefix_detection_suffixes": ["options", "posts", "users"],

    "table_suffixes": {
      "core": ["commentmeta", "comments", "links", "options", "postmeta",
               "posts", "termmeta", "terms", "term_relationships", "term_taxonomy"],
      "users": ["users", "usermeta"],
      "network": ["blogs", "blogmeta", "site", "sitemeta", "registration_log", "signups"]
    },

    "protected_suffixes": ["options", "posts", "postmeta", "users", "usermeta",
                          "comments", "commentmeta", "terms", "termmeta",
                          "term_relationships", "term_taxonomy", "links",
                          "blogs", "blogmeta", "site", "sitemeta",
                          "registration_log", "signups"],

    "default_grouping": {
      "id": "wordpress-tables",
      "name": "WordPress Tables",
      "pattern_template": "{{prefix}}*"
    },

    "multisite_grouping": {
      "network": {
        "id": "wordpress-network",
        "name": "Network Tables"
      },
      "site": {
        "id_template": "wordpress-site-{{blogId}}",
        "name_template": "{{siteName}}",
        "pattern_template": "{{sitePrefix}}*"
      }
    }
  },

  "deploy": [
    {
      "path_pattern": "/wp-content/plugins/",
      "verify_command": "find {{targetDir}} -maxdepth 2 -name '*.php' -exec grep -l 'Plugin Name:' {} + 2>/dev/null | head -1",
      "verify_error_message": "No WordPress plugin header found in {{targetDir}}"
    },
    {
      "path_pattern": "/wp-content/themes/",
      "verify_command": "grep -l 'Theme Name:' {{targetDir}}/style.css 2>/dev/null",
      "verify_error_message": "No WordPress theme header found in {{targetDir}}/style.css"
    }
  ],

  "deploy_override": [
    {
      "path_pattern": "/wp-content/plugins/",
      "staging_path": "/tmp/homeboy-staging",
      "install_command": "cd {{siteRoot}} && plugin_slug=$(basename {{targetDir}}) && ([ -d {{targetDir}} ] && echo 'WARNING: Removing existing plugin directory' && rm -rf {{targetDir}} || true) && {{cliPath}} plugin install {{stagingArtifact}} --force --url={{domain}}",
      "cleanup_command": "rm -f {{stagingArtifact}}",
      "skip_permissions_fix": true
    },
    {
      "path_pattern": "/wp-content/themes/",
      "staging_path": "/tmp/homeboy-staging",
      "install_command": "cd {{siteRoot}} && theme_slug=$(basename {{targetDir}}) && ([ -d {{targetDir}} ] && echo 'WARNING: Removing existing theme directory' && rm -rf {{targetDir}} || true) && {{cliPath}} theme install {{stagingArtifact}} --force --url={{domain}}",
      "cleanup_command": "rm -f {{stagingArtifact}}",
      "skip_permissions_fix": true
    }
  ],

  "version_patterns": [
    {
      "extension": ".php",
      "pattern": "Version:\\s*(\\d+\\.\\d+\\.\\d+)"
    }
  ],

  "build": {
    "artifact_extensions": [".zip"],
    "script_names": ["build.sh"],
    "command_template": "bash {{script}}",
    "module_script": "scripts/build.sh",
    "pre_build_script": "scripts/validate-build.sh",
    "artifact_pattern": "build/{component_id}.zip"
  },

  "runtime": {
    "setup_command": "bash {{module_path}}/scripts/setup.sh",
    "ready_check": "test -f {{module_path}}/vendor/wp-phpunit/wp-phpunit/includes/bootstrap.php",
    "run_command": "bash {{module_path}}/scripts/test-runner.sh"
  },

  "testing": {
    "supported_databases": ["sqlite", "mysql"],
    "default_database": "sqlite"
  },

  "settings": [
    {
      "id": "user",
      "label": "WP-CLI User",
      "type": "string",
      "default": "",
      "description": "WordPress user for WP-CLI commands (email, login, or ID). When configured, automatically appended as --user flag."
    },
    {
      "id": "database_type",
      "label": "Database Type",
      "type": "string",
      "default": "sqlite",
      "description": "Database backend for tests. Valid values: 'sqlite' (in-memory, fastest) or 'mysql' (for production parity)"
    },
    {
      "id": "mysql_host",
      "label": "MySQL Host",
      "type": "string",
      "default": "localhost",
      "description": "MySQL host (when using mysql database type)"
    },
    {
      "id": "mysql_database",
      "label": "MySQL Database",
      "type": "string",
      "default": "wordpress_test",
      "description": "MySQL database name (when using mysql database type)"
    },
    {
      "id": "mysql_user",
      "label": "MySQL User",
      "type": "string",
      "default": "root",
      "description": "MySQL user (when using mysql database type)"
    },
    {
      "id": "mysql_password",
      "label": "MySQL Password",
      "type": "string",
      "default": "",
      "description": "MySQL password (when using mysql database type)"
    }
  ],

  "commands": ["wp", "wp-test"]
}
